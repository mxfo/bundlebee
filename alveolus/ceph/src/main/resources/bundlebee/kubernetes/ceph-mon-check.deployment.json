{
  "kind": "Deployment",
  "apiVersion": "apps/v1beta1",
  "metadata": {
    "name": "ceph-mon-check"
  },
  "spec": {
    "replicas": 1,
    "template": {
      "metadata": {
        "labels": {
          "release_group": "RELEASE-NAME",
          "application": "ceph",
          "component": "moncheck",
          "app.kubernetes.io/managed-by": "bundlebee",
          "deploy.by": "{{user.name:-unknown}}",
          "deploy.time": "{{annotations.deploytime}}",
          "deploy.environment": "{{annotations.environment}}",
          "project.version": "{{project.version}}"
        }
      },
      "spec": {
        "affinity": {
          "podAntiAffinity": {
            "preferredDuringSchedulingIgnoredDuringExecution": [
              {
                "podAffinityTerm": {
                  "labelSelector": {
                    "matchExpressions": [
                      {
                        "key": "release_group",
                        "operator": "In",
                        "values": [
                          "RELEASE-NAME"
                        ]
                      },
                      {
                        "key": "application",
                        "operator": "In",
                        "values": [
                          "ceph"
                        ]
                      },
                      {
                        "key": "component",
                        "operator": "In",
                        "values": [
                          "moncheck"
                        ]
                      }
                    ]
                  },
                  "topologyKey": "kubernetes.io/hostname"
                },
                "weight": 10
              }
            ]
          }
        },
        "nodeSelector": {
          "ceph-mon": "enabled"
        },
        "serviceAccount": "default",
        "initContainers": [
          {
            "name": "init",
            "image": "docker.io/kolla/ubuntu-source-kubernetes-entrypoint:4.0.0",
            "imagePullPolicy": "IfNotPresent",
            "env": [
              {
                "name": "POD_NAME",
                "valueFrom": {
                  "fieldRef": {
                    "apiVersion": "v1",
                    "fieldPath": "metadata.name"
                  }
                }
              },
              {
                "name": "NAMESPACE",
                "valueFrom": {
                  "fieldRef": {
                    "apiVersion": "v1",
                    "fieldPath": "metadata.namespace"
                  }
                }
              },
              {
                "name": "INTERFACE_NAME",
                "value": "eth0"
              },
              {
                "name": "DEPENDENCY_SERVICE",
                "value": "ceph-mon"
              },
              {
                "name": "DEPENDENCY_JOBS",
                "value": ""
              },
              {
                "name": "DEPENDENCY_DAEMONSET",
                "value": ""
              },
              {
                "name": "DEPENDENCY_CONTAINER",
                "value": ""
              },
              {
                "name": "COMMAND",
                "value": "echo done"
              }
            ],
            "command": [
              "kubernetes-entrypoint"
            ],
            "volumeMounts": [
            ]
          },
          {
            "name": "ceph-init-dirs",
            "image": "docker.io/ceph/daemon:tag-build-master-luminous-ubuntu-16.04",
            "imagePullPolicy": "IfNotPresent",
            "command": [
              "/tmp/init_dirs.sh"
            ],
            "volumeMounts": [
              {
                "name": "ceph-bin",
                "mountPath": "/tmp/init_dirs.sh",
                "subPath": "init_dirs.sh",
                "readOnly": true
              },
              {
                "name": "ceph-bin",
                "mountPath": "/variables_entrypoint.sh",
                "subPath": "variables_entrypoint.sh",
                "readOnly": true
              },
              {
                "name": "pod-var-lib-ceph",
                "mountPath": "/var/lib/ceph",
                "readOnly": false
              }
            ]
          }
        ],
        "containers": [
          {
            "name": "ceph-mon",
            "image": "docker.io/ceph/daemon:tag-build-master-luminous-ubuntu-16.04",
            "imagePullPolicy": "IfNotPresent",
            "env": [
              {
                "name": "K8S_HOST_NETWORK",
                "value": "1"
              },
              {
                "name": "NAMESPACE",
                "valueFrom": {
                  "fieldRef": {
                    "apiVersion": "v1",
                    "fieldPath": "metadata.namespace"
                  }
                }
              }
            ],
            "command": [
              "/watch_mon_health.sh"
            ],
            "ports": [
              {
                "containerPort": 6789
              }
            ],
            "volumeMounts": [
              {
                "name": "ceph-bin",
                "mountPath": "/watch_mon_health.sh",
                "subPath": "watch_mon_health.sh",
                "readOnly": true
              },
              {
                "name": "ceph-bin",
                "mountPath": "/check_zombie_mons.py",
                "subPath": "check_zombie_mons.py",
                "readOnly": true
              },
              {
                "name": "ceph-bin",
                "mountPath": "/common_functions.sh",
                "subPath": "common_functions.sh",
                "readOnly": true
              },
              {
                "name": "ceph-etc",
                "mountPath": "/etc/ceph/ceph.conf",
                "subPath": "ceph.conf",
                "readOnly": true
              },
              {
                "name": "ceph-client-admin-keyring",
                "mountPath": "/etc/ceph/ceph.client.admin.keyring",
                "subPath": "ceph.client.admin.keyring",
                "readOnly": true
              },
              {
                "name": "ceph-mon-keyring",
                "mountPath": "/etc/ceph/ceph.mon.keyring",
                "subPath": "ceph.mon.keyring",
                "readOnly": true
              },
              {
                "name": "ceph-bootstrap-osd-keyring",
                "mountPath": "/var/lib/ceph/bootstrap-osd/ceph.keyring",
                "subPath": "ceph.keyring",
                "readOnly": true
              },
              {
                "name": "ceph-bootstrap-mds-keyring",
                "mountPath": "/var/lib/ceph/bootstrap-mds/ceph.keyring",
                "subPath": "ceph.keyring",
                "readOnly": true
              },
              {
                "name": "ceph-bootstrap-rgw-keyring",
                "mountPath": "/var/lib/ceph/bootstrap-rgw/ceph.keyring",
                "subPath": "ceph.keyring",
                "readOnly": true
              },
              {
                "name": "pod-var-lib-ceph",
                "mountPath": "/var/lib/ceph",
                "readOnly": false
              },
              {
                "name": "pod-run",
                "mountPath": "/run",
                "readOnly": false
              }
            ]
          }
        ],
        "volumes": [
          {
            "name": "ceph-etc",
            "configMap": {
              "name": "ceph-etc",
              "defaultMode": 292
            }
          },
          {
            "name": "ceph-bin",
            "configMap": {
              "name": "ceph-bin",
              "defaultMode": 365
            }
          },
          {
            "name": "pod-var-lib-ceph",
            "emptyDir": {
            }
          },
          {
            "name": "pod-run",
            "emptyDir": {
              "medium": "Memory"
            }
          },
          {
            "name": "ceph-client-admin-keyring",
            "secret": {
              "secretName": "ceph-client-admin-keyring"
            }
          },
          {
            "name": "ceph-mon-keyring",
            "secret": {
              "secretName": "ceph-mon-keyring"
            }
          },
          {
            "name": "ceph-bootstrap-osd-keyring",
            "secret": {
              "secretName": "ceph-bootstrap-osd-keyring"
            }
          },
          {
            "name": "ceph-bootstrap-mds-keyring",
            "secret": {
              "secretName": "ceph-bootstrap-mds-keyring"
            }
          },
          {
            "name": "ceph-bootstrap-rgw-keyring",
            "secret": {
              "secretName": "ceph-bootstrap-rgw-keyring"
            }
          }
        ]
      }
    }
  }
}
